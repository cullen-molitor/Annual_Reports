---
output: 
  word_document:
    reference_docx: Meta_Data/template_temp.docx
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding,
  output_dir = "Output_Documents") })
---
# Appendix L. Temperature Data by Site

The temperature graphs are divided into a right graph and left graph. The left graph displays the mean daily temperature, as well as the daily temperature range, for the current year. The right graph displays temperature values for the current year compared to past years. Blue diamonds indicate the mean monthly temperatures for the current year. Violin plots indicate the distribution of all past years monthly mean temperature values. If more than seven days of temperature values are missing from any month, due to instrument loss or failure, all temperature values for that particular month/year are excluded. Graphs are ordered by site longitude, from west to east.

```{r Temperature setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("global_markdown.R")
temp_Raw <- readr::read_csv("Tidy_Data_Dont_Touch/Temp_Raw_Tidy.csv") %>% 
  dplyr::filter(Year <= Export_END_Year)
temp_Raw$Month <- factor(temp_Raw$Month, levels = MonthLevels)
temp_Raw$SiteName <- factor(temp_Raw$SiteName, levels = siteInfo1$SiteName)
temp_Daily_Summary <- temp_Raw %>%
  subset(Date >= glue("{Year_to_Filter_Data_by - 1}-05-01") & Date <= glue("{Year_to_Filter_Data_by}-04-30"))

```
```{r Temperature Plots, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=10}

for (i in levels(temp_Raw$SiteName)) {
  
  temp_daily_subset <- filter(temp_Daily_Summary, SiteName == i)
  
  temp_monthly_subset <- filter(temp_Raw, SiteName == i) %>% 
    dplyr::distinct(SiteNumber, Year, Month, Temp_Monthly_Mean, .keep_all = TRUE)
  
  p1 <- ggplot2::ggplot(data = temp_daily_subset, aes(x = Date, y = Temp_Daily_Mean)) +
    ggplot2::geom_ribbon(aes(ymin = Temp_Daily_Min, ymax = Temp_Daily_Max, fill = SiteCode), alpha = .6) +
    ggplot2::geom_line(size = 1, aes(color = SiteCode)) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b \n %Y") +
    scale_y_continuous(limits = c(min(temp_daily_subset$Temp_Daily_Min), 
                                  max(temp_daily_subset$Temp_Daily_Max)),
                       expand = expansion(add = .1)) +
    scale_fill_manual(labels = "Daily temperature range", values = "grey") +
    scale_color_manual(labels = "Mean daily temperature", values = "black") +
    labs(x =  NULL, y = NULL,
         color = NULL,
         fill = NULL) +
    theme_classic2() +
    theme(plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
          plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
          legend.position = "bottom",
          panel.grid.major = element_line(),
          legend.justification = c(0,0.5),
          legend.key.width = unit(.75, "cm"),
          legend.background = element_rect(size = unit(5, "cm")),
          legend.title = element_text(size = 12, color = "black"),
          legend.text = element_text(size = 11, colour = "black"),
          axis.text.x = element_text(angle = 0, hjust = .5, vjust = .5, size = 12, face = "bold"),
          axis.text.y = element_text(angle = 0, hjust = 1, vjust = 1, size = 12, face = "bold"),)
  
  p2 <- ggplot2::ggplot() +
    ggplot2::geom_violin(data = temp_monthly_subset, color = "lightblue", alpha = .8,
                         aes(x = Month, y = Temp_Monthly_Mean, group = Month, fill = SiteCode)) +
    ggplot2::geom_boxplot(data = temp_monthly_subset, width = .08,
                          aes(x = Month, y = Temp_Monthly_Mean, group = Month)) +
    ggplot2::geom_point(data = temp_daily_subset, shape = 23, size = 2, stroke = 2,
                        aes(x = Month, y = Temp_Monthly_Mean, color = SiteCode)) +
    scale_y_continuous(limits = c(min(temp_daily_subset$Temp_Daily_Min),
                                  max(temp_daily_subset$Temp_Daily_Max)),
                       # sec.axis = ~ . * (9 / 5) + 32, # This gives a weird error, only plots first 16 sites
                       expand = expansion(add = .1)) +
    scale_fill_manual(labels = "Monthly mean temp distribution, all years", values = "lightblue") +
    scale_color_manual(labels = glue("Monthly mean temp ({Year_to_Filter_Data_by - 1}/{Year_to_Filter_Data_by})"), values = "blue") +
    labs(x =  NULL, y = NULL, 
         color = NULL,
         fill = NULL) +
    theme_classic2() +
    theme(plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
          plot.subtitle = element_text(hjust = 0.5, size = 16, face = "bold"),
          legend.position = "bottom",
          panel.grid.major = element_line(),
          legend.justification = c(0,0.5),
          legend.key.width = unit(.75, "cm"),
          legend.background = element_rect(size = unit(5, "cm")),
          legend.title = element_text(size = 12, color = "black"),
          legend.text = element_text(size = 11, colour = "black"),
          axis.text.x = element_text(angle = 0, hjust = 1, vjust = 1, size = 12, face = "bold"),
          strip.text = element_text(size = 12, colour = "black", angle = 90),
          axis.line.y = element_blank(),
          axis.text.y.left = element_blank(),
          axis.text.y.right = element_text(hjust = 1, vjust = 1, size = 12, face = "bold"),
          panel.grid.major.x = element_blank(),
          axis.ticks.y = element_blank())
  
  
  plot <- ggarrange(p1, p2, ncol = 2, align = "h", common.legend = FALSE)
  
  a <- annotate_figure(
    plot, top = text_grob(paste(temp_daily_subset$IslandName, temp_daily_subset$SiteName), 
                          color = "black", face = "bold", size = 18, hjust = .5, x = .5),
    # right = text_grob("Temperature (°F)", color = "black", rot = 270, face = "bold", size = 18), # sec.axis not working for all
    left = text_grob("Temperature (°C)", color = "black", rot = 90, face = "bold", size = 18)
  )
  print(a)
}

```